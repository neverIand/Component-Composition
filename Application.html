<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
  <title>Component Composition</title>

  <script>
    // loading window controller
    function showMsg(isLoading) {
      if (isLoading) {
        $('#app').attr('style', '-webkit-filter: blur(3px)');
        $('#app').attr('style', 'filter: blur(3px)');
        $('#main-title').attr('style', '-webkit-filter: blur(3px)');
        $('#main-title').attr('style', 'filter: blur(3px)');
        $('#loading-screen').attr('style', 'display: flex');
      } else {
        $('#app').attr('style', '-webkit-filter: blur(0px)');
        $('#app').attr('style', 'filter: blur(0px)');
        $('#main-title').attr('style', '-webkit-filter: blur(0px)');
        $('#main-title').attr('style', 'filter: blur(0px)');
        $('#loading-screen').attr('style', 'display: none');
      }
    }

    // template declaration, using ES6 syntax
    /* Hotel Card Declaration */
    class WeatherCard extends HTMLElement {
      constructor() {
        super();

        const templateContent = document.querySelector('#weather-card-template').content;

        const shadowRoot = this.attachShadow({
          mode: 'open'
        });

        shadowRoot.appendChild(templateContent.cloneNode(true));

        const date = this.getAttribute('date');
        const condition = this.getAttribute('condition');
        const iconURL = this.getAttribute('iconURL');
        const avgtemp = this.getAttribute('avgtemp');
        const maxtemp = this.getAttribute('maxtemp');
        const mintemp = this.getAttribute('mintemp');
        const rain = this.getAttribute('rain');
        const wind = this.getAttribute('wind');

        shadowRoot.querySelector('h2 span').innerHTML = date;
        shadowRoot.querySelector('h3').innerHTML = '<img class="icon" src="' + iconURL + '">' + condition;
        shadowRoot.querySelector('#avgtemp').innerHTML = avgtemp + " &#8451;";
        shadowRoot.querySelector('#maxtemp').innerHTML = maxtemp + " &#8451;";
        shadowRoot.querySelector('#mintemp').innerHTML = mintemp + " &#8451;";
        shadowRoot.querySelector('#rain').innerHTML = rain + " &#37";
        shadowRoot.querySelector('#wind').innerHTML = wind + " km/h";
      }
    }
    customElements.define('weather-card', WeatherCard);

    /* Hotel Card Declaration */
    class HotelCard extends HTMLElement {
      constructor() {
        super();

        const templateContent = document.querySelector('#hotel-card-template').content;

        const shadowRoot = this.attachShadow({
          mode: 'open'
        });

        shadowRoot.appendChild(templateContent.cloneNode(true));

        const name = this.getAttribute('name');
        const rating = parseFloat(this.getAttribute('rating'));
        const addr = this.getAttribute('addr');
        const postalCode = this.getAttribute('postalCode');
        const phone = this.getAttribute('phone');
        const pic = this.getAttribute('pic');

        shadowRoot.querySelector('h2').innerHTML = name;
        shadowRoot.querySelector('h3').innerHTML = 'Rating: '
        for (let i = 0; i < rating; i++) {
          shadowRoot.querySelector('h3').innerHTML += '<span style="font-size: 16px; color: gold">&#9733;</span>';
        }
        shadowRoot.querySelector('#addr').innerHTML = addr;
        shadowRoot.querySelector('#postalCode').innerHTML = postalCode;
        shadowRoot.querySelector('#phone').innerHTML = phone;
        shadowRoot.querySelector('#pic').innerHTML = '<img class="icon" src="' + pic + '">';
      }
    }
    customElements.define('hotel-card', HotelCard);
  </script>
</head>

<body>

  <!-- ################### -->
  <!-- Weather Card Template -->
  <!-- ################### -->
  <template id="weather-card-template">
    <style>
      .weather-card {
        position: relative;
        display: block;
        width: 520px;
        margin: 0 auto;
        color: black;
      }

      .weather-card .tr-card {
        padding: 10px;
        font-family: Arial, Helvetica, sans-serif !important;
        border: 2px solid black;
        border-radius: 5px;
        box-shadow: 0px 2px 30px -14px grey;
        background-color: white;
      }

      .tr-card h2,
      .tr-card h3 {
        margin: 0;
        font-weight: bold;
      }

      .tr-card h2 {
        font-size: 18px !important;
      }

      .tr-card h3 {
        font-size: 14px !important;
      }

      .tr-card-body {
        font-size: 16px !important;
      }

      table {
        width: 100%;
      }

      table,
      th,
      td {
        margin-top: 10px;
        padding: 5px;
        border-collapse: collapse;
        border: 1px solid black;
      }

      .icon {
        width: 20px;
      }
    </style>

    <div class="weather-card">

      <div class="tr-card">
        <h2>Date: <span></span></h2>
        <h3></h3>

        <div class="tr-card-body">
          <table>
            <tr>
              <td>Average Temperature</td>
              <td id="avgtemp"></td>
            </tr>

            <tr>
              <td>Max Temperature</td>
              <td id="maxtemp"></td>
            </tr>

            <tr>
              <td>Min Temperature</td>
              <td id="mintemp"></td>
            </tr>

            <tr>
              <td>Chance of rain</td>
              <td id="rain"></td>
            </tr>

            <tr>
              <td>Max Wind Speed</td>
              <td id="wind"></td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </template>

  <!-- ################### -->
  <!-- Hotel Card Template -->
  <!-- ################### -->
  <template id="hotel-card-template">
    <style>
      .hotel-card {
        display: block;
        width: 520px;
        margin: 0 auto;
        color: black;
      }

      .hotel-card .tr-card {
        padding: 10px;
        font-family: Arial, Helvetica, sans-serif !important;
        border: 2px solid black;
        border-radius: 5px;
        box-shadow: 0px 2px 30px -14px grey;
        background-color: white;
      }

      .tr-card h2,
      .tr-card h3 {
        margin: 0;
        font-weight: bold;
      }

      .tr-card h2 {
        font-size: 18px !important;
      }

      .tr-card h3 {
        font-size: 14px !important;
      }

      .tr-card-body {
        font-size: 16px !important;
      }

      .tr-card-body tr {
        max-width: 200px;
      }

      h4 {
        margin: 0;
      }

      table {
        width: 100%;
      }

      table,
      th,
      td {
        margin-top: 10px;
        padding: 5px;
        border-collapse: collapse;
        border: 1px solid black;
      }

      .icon {
        width: 200px;
      }
    </style>

    <div class="hotel-card">

      <div class="tr-card">
        <h2></h2>
        <h3></h3>

        <div class="tr-card-body">
          <table>
            <tr>
              <td>
                <h4>Address</h4>
              </td>
              <td rowspan="6" id="pic"></td>
            </tr>

            <tr>
              <td id="addr"></td>
            </tr>

            <tr>
              <td>
                <h4>Postal Code</h4>
              </td>

            </tr>

            <tr>
              <td id="postalCode"></td>
            </tr>

            <tr>
              <td>
                <h4>Phone</h4>
              </td>

            </tr>

            <tr>
              <td id="phone"></td>
            </tr>


          </table>
        </div>
      </div>

    </div>

  </template>

  <style>
    @keyframes r {

      0% {
        -webkit-transform: rotate(0deg);
      }

      50% {
        -webkit-transform: rotate(180deg);
      }

      100% {
        -webkit-transform: rotate(360deg);
      }
    }

    @-webkit-keyframes r {

      0% {
        -webkit-transform: rotate(0deg);
      }

      50% {
        -webkit-transform: rotate(180deg);
      }

      100% {
        -webkit-transform: rotate(360deg);
      }
    }

    @keyframes spotlight {

      0% {
        clip-path: ellipse(100px 100px at 0% 50%);
        -webkit-clip-path: ellipse(100px 100px at 0% 50%);
      }

      50% {
        clip-path: ellipse(100px 100px at 100% 50%);
        -webkit-clip-path: ellipse(100px 100px at 100% 50%);
      }

      100% {
        clip-path: ellipse(100px 100px at 0% 50%);
        -webkit-clip-path: ellipse(100px 100px at 0% 50%);
      }
    }

    * {
      margin: 0;
      padding: 0;
    }

    :root {
      --main-theme: rgb(2, 108, 119);
      --light-blue: rgb(204, 244, 245);
      --light-green: rgb(210, 255, 228);
      --dark-green: rgb(10, 104, 68);
    }

    html {
      font-family: Arial, Helvetica, sans-serif !important;
      background-color: var(--light-green);
    }

    #loading-screen {
      position: fixed;
      display: none;
      text-align: center;
      justify-content: center;
      align-items: center;
      top: 0;
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgb(255, 255, 255, 0);
      /* Ensure the div is above the page */
      z-index: 101;
    }


    #loading-msg {
      padding: 20px;
      color: var(--main-theme);
      border: 1px solid var(--main-theme);
      background-color: var(--light-blue);
      box-shadow: 0px 0px 200px 1px #878787;
    }

    .fa.fa-circle-o-notch {
      animation: r 1s linear infinite;
    }

    #main-title {
      position: relative;
      width: 600px;
      margin: 32px auto;
      color: var(--dark-green);
      font-size: 1.2em;
      z-index: 100;
    }

    #main-title h1::after {
      content: attr(data-spotlight);
      position: absolute;
      top: 0;
      left: 0;
      color: transparent;
      background-image: linear-gradient(-180deg, rgb(2, 108, 119), rgb(205, 243, 255));
      background-size: cover;
      background-position: center center;
      background-clip: text;
      -webkit-background-clip: text;
      animation: spotlight 8s infinite;
    }

    #app {
      position: relative;
      margin: 10px auto;
      padding: 10px;
      width: 600px;
      background-color: var(--light-blue);
      border: 1px solid var(--dark-green);
      border-radius: 4px;
      box-shadow: 0px 0px 6px 1px #acacac;
      z-index: 100;
    }

    .input-area {
      margin-top: 10px;
      /* margin-bottom: 10px; */
      padding-bottom: 10px;
      border-bottom: 1px solid var(--dark-green);
      background-color: var(--light-blue);
    }

    select {
      padding: 2px 5px;
      border-radius: 4px;
    }


    #weather-list,
    #ac-list {
      list-style: none;
      margin-top: 10px;
      padding-top: 10px;
      max-height: 338px;
      overflow-y: scroll;
      border-top: 1px solid var(--dark-green);
      border-bottom: 1px solid var(--dark-green);
    }

    #weather-list li,
    #ac-list li {
      margin-top: 10px;
      margin-bottom: 10px;
    }

    h2 {
      color: var(--main-theme);
      margin: 10px 0;
    }

    .content {
      margin: 20px;
    }
  </style>

  <div id="loading-screen">
    <div id="loading-msg">
      <i class="fa fa-circle-o-notch" style="font-size:48px;"></i>
      <h1>Fetching data, please wait...</h1>
    </div>
  </div>

  <div id="main-title">
    <h1 data-spotlight="Component Composition">Component Composition</h1>
  </div>

  <div id="app">

    <!-- 1. Get the list of public holiday of selected country: -->
    <!-- 1a. get all the available countries -->

    <div id="app-form">
      <div id="country-info" class="input-area">
        <h2>Select a Country or Region:</h2>
        <select name="country" id="select-country" onchange="searchCountry();">
          <option value="placeholder">Select a country</option>
          <!-- <option value="CN&China">ChinaTest</option> -->
        </select>
      </div>

      <div id="area-info" style="display: none;" class="input-area">
        <h2>Select a state or province</h2>
        <select name="area" id="area-list" onchange="selectArea();">
          <option value="a-placeholder">Select the area</option>
        </select>
      </div>

      <div id="city-info" style="display: none;" class="input-area">
        <h2>Select a city or subordinate district</h2>
        <select name="city" id="city-list" onchange="selectCity();">
          <option value="c-placeholder">Select the city</option>
        </select>
      </div>

      <div id="holiday-info" style="display: none;" class="input-area">
        <h2>Public Holidays:</h2>
        <select name="holiday" id="holiday-list" onchange="selectHoliday();" style="max-width: 580px;">
          <option value="h-placeholder">Select a holiday</option>
        </select>
      </div>

      <div id="weather-info" style="display: none;">
        <h2>Weather of the selected place</h2>
        <ul id="weather-list">

        </ul>
      </div>

      <div id="ac-info" style="display: none;">
        <h2>Accommodation Rental Info</h2>
        <!-- This is the default setting of the api, in theory the type of the room (and more) can also be configured -->
        <p>Below are hotels that can provide at least 1 room for 2 adult guests on the selected date. Hotel data is
          sorted by distance from the nearest to far.</p>
        <ul id="ac-list">

        </ul>
      </div>

    </div>

    <!-- <button id="btn">TEST</button>
    <div class="content">

    </div> -->
  </div>

  <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js">
  </script>

  <script>
    // Some apis may need to regenerate key every day
    // https://calendarific.com/account

    // calendarific
    const countryURL = 'https://calendarific.com/api/v2/countries'
    const countryData = 'https://calendarific.com/api/v2/countries?&api_key=f92699ea84a0a64aa0b3d7f605f8a36d081c00a6'

    // token for REST API for countries
    const api_token = "i7c8mYeYUSr9OMq0jSIk8MJdFAHqRpZtXZ_ec7FdClkKgWnG_vqueBorQq-9Y5o-kpg"

    var selectedCountry = null;
    var selectedHoliday = null;
    var selectedCity = null;

    // longtitude and latitude of the selected city
    // acquired by weather api
    var lon = null;
    var lat = null;

    // get all the available countries when the page loaded
    // !This api has limitation on request number!
    document.addEventListener('DOMContentLoaded', (event) => {
      $.ajax({
        type: 'GET',
        url: countryURL,
        data: countryData,
        dataType: 'JSON',
        error: function () {
          alert('Network Error: Failed getting available countries, please try again');
          showMsg(false);
        },
        success: function (res) {
          $.each(res.response.countries, function (index, item) {
            $('#select-country').append(
              '<option value="' + item['iso-3166'] + '&' + item.country_name + '">' + item
              .country_name + '</option>')
          })

        }
      })
    });


    // get all the available countries and generate options
    function searchCountry() {
      // iso-3166 code
      $('#holiday-list').html('');
      $('#holiday-info').attr('style', 'display:none;');
      var selectedData = $('#select-country').val();

      // this is an array with format: iso3166code&countryname
      selectedCountry = selectedData.split('&')[0]; // iso-3166 code
      var countryName = selectedData.split('&')[1]; // actual name

      console.log('selectedCountry: ' + selectedCountry);
      console.log('countryName: ' + countryName);

      // https://www.universal-tutorial.com/rest-apis/free-rest-api-for-country-state-city
      // token: i7c8mYeYUSr9OMq0jSIk8MJdFAHqRpZtXZ_ec7FdClkKgWnG_vqueBorQq-9Y5o-kpg

      if ($('#select-country').val() != 'placeholder') {

        showMsg(true);
        $('#area-list').html('');
        $('#area-info').attr('style', 'display:none;');
        $('#city-list').html('');
        $('#city-info').attr('style', 'display:none;');
        $('#weather-list').html('');
        $('#weather-info').attr('style', 'display:none;');
        $('#ac-list').html('');
        $('#ac-info').attr('style', 'display:none;');

        // get all the areas (cities) of this country
        $.ajax({
          type: 'GET',
          url: 'https://www.universal-tutorial.com/api/getaccesstoken',
          headers: {
            "Accept": "application/json",
            "api-token": api_token,
            "user-email": "ratch3t@foxmail.com"
          },
          dataType: 'JSON',
          error: function () {
            alert('Network Error: Failed getting the access token for areas, please try again');
            showMsg(false);
          },
          success: function (res) {

            var token = res.auth_token

            $.ajax({
              type: 'GET',
              url: 'https://www.universal-tutorial.com/api/states/' + countryName,
              headers: {
                "Authorization": 'Bearer ' + token,
                "Accept": "application/json"
              },
              dataType: 'JSON',
              error: function () {
                alert('Network Error: Failed getting areas, please try again');
                showMsg(false);
              },
              success: function (res) {
                // remove the loading prompt
                showMsg(false);

                $('#area-list').html('<option value="a-placeholder">Select an area</option>')
                $('#area-info').attr('style', 'display:block;');
                $.each(res, function (index, item) {
                  $('#area-list').append(
                    '<option value="' + item.state_name + '">' + item.state_name + '</option>')
                })

              }
            })

          }
        })
      } else {
        alert('invalid selection');
      }
    }

    function selectArea() {
      $('#weather-list').html('');
      $('#weather-info').attr('style', 'display:none;');
      $('#city-list').html('');
      $('#city-info').attr('style', 'display:none;');

      $('#holiday-list').html('');
      $('#holiday-info').attr('style', 'display:none;');
      $('#ac-list').html('');
      $('#ac-info').attr('style', 'display:none;');
      let selectedArea = $('#area-list').val();

      // get the exact city
      if (selectedArea != 'a-placeholder') {

        showMsg(true);

        $.ajax({
          type: 'GET',
          url: 'https://www.universal-tutorial.com/api/getaccesstoken',
          headers: {
            "Accept": "application/json",
            "api-token": api_token,
            "user-email": "ratch3t@foxmail.com"
          },
          dataType: 'JSON',
          error: function () {
            alert('Network Error: Failed getting the access token for areas, please try again');
            showMsg(false);
          },
          success: function (res) {

            var token = res.auth_token

            $.ajax({
              type: 'GET',
              url: 'https://www.universal-tutorial.com/api/cities/' + selectedArea,
              headers: {
                "Authorization": 'Bearer ' + token,
                "Accept": "application/json"
              },
              dataType: 'JSON',
              error: function () {
                alert('Network Error: Failed getting cities, please try again');
                showMsg(false);
              },
              success: function (res) {

                showMsg(false)

                if (res.length > 1) {
                  $('#city-list').html('<option value="c-placeholder">Select a city or district</option>')
                  $('#city-info').attr('style', 'display:block;');
                  $.each(res, function (index, item) {
                    $('#city-list').append(
                      '<option value="' + item.city_name + '">' + item.city_name + '</option>')
                  })
                } else {
                  selectedCity = selectedArea;
                  alert('This area does not have subordinate city or district. Please continue.')

                  let year = 2021;

                  const cholidaysURL = 'https://calendarific.com/api/v2/holidays'
                  const colidayData =
                    'https://calendarific.com/api/v2/holidays?&api_key=f92699ea84a0a64aa0b3d7f605f8a36d081c00a6' +
                    '&country=' + selectedCountry + '&year=' + year;
                  $.ajax({
                    type: 'GET',
                    url: cholidaysURL,
                    data: colidayData,
                    dataType: 'JSON',
                    crossDomain: true,
                    error: function () {
                      alert('Network Error: Failed getting holiday info, please try again');
                      showMsg(false);
                    },
                    success: function (res) {

                      showMsg(false);
                      // now there is holiday date and city info
                      $('#holiday-list').html(
                        '<option value="h-placeholder">Select a holiday</option>'
                      )

                      $('#holiday-info').attr('style', 'display:block;');

                      $.each(res.response.holidays, function (index, item) {
                        $('#holiday-list').append(
                          '<option value="' + item.date.iso + '">' + item.name + ' | ' + item
                          .date
                          .iso + '</option>')

                      })

                    }
                  })
                }
              }
            })

          }
        })

      } else {
        alert('invalid selection')
      }

    }

    // weather api base url
    //http://api.weatherunlocked.com/ or https://api.weatherunlocked.com/
    //appid:b39b995a
    //key:c87d719883516b97659376147a87a98c

    function selectCity() {
      $('#weather-list').html('')
      $('#weather-info').attr('style', 'display:none;');
      $('#holiday-list').html('');
      $('#holiday-info').attr('style', 'display:none;');
      $('#ac-list').html('');
      $('#ac-info').attr('style', 'display:none;');

      selectedCity = $('#city-list').val();

      // the user can now select the holiday
      console.log(selectedCity)
      if (selectedCity != 'c-placeholder') {
        showMsg(true);
        //get all the holidays of this country

        let year = 2021;

        const cholidaysURL = 'https://calendarific.com/api/v2/holidays'
        const colidayData =
          'https://calendarific.com/api/v2/holidays?&api_key=f92699ea84a0a64aa0b3d7f605f8a36d081c00a6' +
          '&country=' + selectedCountry + '&year=' + year;
        $.ajax({
          type: 'GET',
          url: cholidaysURL,
          data: colidayData,
          dataType: 'JSON',
          crossDomain: true,
          error: function () {
            alert('Network Error: Failed getting holiday info, please try again');
            showMsg(false);
          },
          success: function (res) {

            showMsg(false);
            // now there is holiday date and city info

            $('#holiday-list').html(
              '<option value="h-placeholder">Select a holiday</option>') // remove the previous content

            $('#holiday-info').attr('style', 'display:block;');

            $.each(res.response.holidays, function (index, item) {
              // filter the data so that only public holidays will be displayed
              // season like June Solstice (夏至) does not count 
              var holidayType = item['type'][0]
              // console.log('type: ' + holidayType + ' typeof: ' + typeof (holidayType));
              if (holidayType === 'National holiday') {
                $('#holiday-list').append(
                  '<option value="' + item.date.iso + '">' + item.name + ' | ' + item.date
                  .iso + '</option>')
              } else {
                console.log(item.name + ' does not count as public holiday');
              }


            })

          }
        })
      } else {

        alert('Invalid selection of city')
      }


    }

    function selectHoliday() {

      $('#ac-list').html('');
      $('#ac-info').attr('style', 'display:none;');

      selectedHoliday = $('#holiday-list').val();
      //console.log(time);
      console.log(selectedHoliday);

      // the maximum range for available weather forecast
      // Unfortunately, free account for weatherapi can only ask for current weather
      // and 3 days of forecast
      const range = 3;

      if (selectedHoliday != 'h-placeholder') {

        let time = getCurrentDate()
        let diff = dateDiff(selectedHoliday, time)

        // #######
        // Case 1: The holiday is too far away
        // #######
        if (diff > range) {
          alert(
            'The selected holiday is too far way to get weather condition, only current weather of that place and available hotels will be displayed'
          )
          $('#weather-list').html('')
          $('#weather-info').attr('style', 'display:none;');

          // #######
          // Get current weather of that place to get longitude and latitude
          // #######

          showMsg(true);

          const api_key = '51563523b41b41b3bd981420212804'
          $.ajax({
            type: 'GET',
            crossDomain: true,
            url: 'http://api.weatherapi.com/v1/current.json?key=' + api_key +
              '&q=' + selectedCity,
            dataType: 'JSON',
            error: function () {
              alert('Network error: Failed getting weather info, please try again');
              showMsg(false);
            },
            success: function (res) {
              lat = res.location.lat;
              lon = res.location.lon;
              console.log('latitude: ' + lat + ' longtitude: ' + lon);
              showMsg(false);
              $('#weather-list').html('')
              $('#weather-info').attr('style',
                'display:block;'); // pass the params to the weather card template

              $('#weather-list').append('<li><weather-card date="' + res.location.localtime +
                '" condition="' +
                res.current.condition.text + '"iconURL="' + res.current.condition.icon + '" avgtemp="' +
                res.current.temp_c +
                '" maxtemp="' + 'not available yet' + '" mintemp="' + 'not available yet' + '" rain="' +
                res.current.cloud + '" wind="' + res.current.wind_kph +
                '"></weather-card></li>')

              // #######
              // Get the information of available hotels
              // #######
              showMsg(true);
              $.ajax({
                type: 'POST',
                crossDomain: true,
                contentType: 'application/x-www-form-urlencoded',
                url: 'https://test.api.amadeus.com/v1/security/oauth2/token',

                data: {
                  'grant_type': 'client_credentials',
                  'client_id': 'zxJ9K59fVIoWH2KPvSl2PXq6yTQ8qOgN',
                  'client_secret': 'sGL8iLgjn8C7yXME'
                },
                dataType: 'JSON',
                error: function () {
                  alert('Network Error: Failed getting token for hotel info, please try again');
                  showMsg(false);
                },
                success: function (res) {
                  const access_token = res.access_token;

                  $.ajax({
                    type: 'GET',
                    crossDomain: true,
                    url: 'https://test.api.amadeus.com/v2/shopping/hotel-offers?latitude=' + lat +
                      '&longitude=' + lon + '&checkInDate=' + selectedHoliday +
                      '&roomQuantity=1&adults=2&radius=25&radiusUnit=KM&paymentPolicy=NONE&includeClosed=true&bestRateOnly=false&view=FULL&sort=DISTANCE',
                    headers: {
                      'Authorization': 'Bearer ' + access_token
                    },
                    dataType: 'JSON',
                    error: function () {
                      alert('Network Error: Failed getting hotel info, please try again');
                      showMsg(false);
                    },
                    success: function (res) {
                      showMsg(false);
                      $('#ac-list').html('')
                      $('#ac-info').attr('style', 'display:block;');
                      let counter = 0; // count available hotel

                      $.each(res.data, function (index, item) {
                        // for now it will only display hotels that are available
                        if (res.data.length == 0) {
                          $('#ac-list').append(
                            '<li style="padding: 10px;"><h2>Sorry, there is no available room on the selected date.</h2></li>'
                          )
                        } else {
                          if (item.available == true) {
                            counter++;
                            $('#ac-list').append('<li><hotel-card name="' + item.hotel.name +
                              '" rating="' + item.hotel.rating + '" addr="' + item.hotel.address
                              .lines.join(', ') +
                              '" postalCode="' + item.hotel.address.postalCode + '" phone="' +
                              item.hotel.contact
                              .phone + '" pic="' +
                              // in case the image of the hotel is not available
                              ((item.hotel.media != undefined || null) ? item.hotel
                                .media[0].uri : '../NoMediaAvailable.png') +
                              '"></hotel-card></li>')
                          }
                        }
                      })

                      if (counter == 0) {
                        $('#ac-list').append(
                          '<li style="padding: 10px;"><h2>Sorry, there is no available room on the selected date.</h2></li>'
                        )
                      }
                    }
                  })
                }
              })


            }
          })


          // #######
          // Case 2: The holiday passed already
          // #######
        } else if (diff < 0) {

          alert('The holiday you choosed is overdue, cannot get weather info and available hotel')
          $('#weather-list').html('')
          $('#weather-info').attr('style', 'display:none;');

          // #######
          // Case 3: The holiday is the day selected
          // #######
        } else if (diff == 0) {
          console.log('display today\'s weather')

          showMsg(true);
          const api_key = '51563523b41b41b3bd981420212804'
          $.ajax({
            type: 'GET',
            crossDomain: true,
            url: 'http://api.weatherapi.com/v1/current.json?key=' + api_key +
              '&q=' + selectedCity,
            dataType: 'JSON',
            error: function () {
              alert('Network error: Failed getting weather info, please try again');
              showMsg(false);
            },
            success: function (res) {
              lat = res.location.lat;
              lon = res.location.lon;
              console.log('latitude: ' + lat + ' longtitude: ' + lon);
              showMsg(false);
              $('#weather-list').html('')
              $('#weather-info').attr('style',
                'display:block;'); // pass the params to the weather card template

              $('#weather-list').append('<li><weather-card date="' + res.location.localtime +
                '" condition="' +
                res.current.condition.text + '"iconURL="' + res.current.condition.icon + '" avgtemp="' +
                res.current.temp_c +
                '" maxtemp="' + 'not available yet' + '" mintemp="' + 'not available yet' + '" rain="' +
                res.current.cloud + '" wind="' + res.current.wind_kph +
                '"></weather-card></li>')

              // #######
              // Get the information of available hotels
              // #######
              showMsg(true);
              $.ajax({
                type: 'POST',
                crossDomain: true,
                contentType: 'application/x-www-form-urlencoded',
                url: 'https://test.api.amadeus.com/v1/security/oauth2/token',

                data: {
                  'grant_type': 'client_credentials',
                  'client_id': 'zxJ9K59fVIoWH2KPvSl2PXq6yTQ8qOgN',
                  'client_secret': 'sGL8iLgjn8C7yXME'
                },
                dataType: 'JSON',
                error: function () {
                  alert('Network Error: Failed getting token for hotel info, please try again');
                  showMsg(false);
                },
                success: function (res) {
                  const access_token = res.access_token;

                  $.ajax({
                    type: 'GET',
                    crossDomain: true,
                    url: 'https://test.api.amadeus.com/v2/shopping/hotel-offers?latitude=' + lat +
                      '&longitude=' + lon + '&checkInDate=' + selectedHoliday +
                      '&roomQuantity=1&adults=2&radius=25&radiusUnit=KM&paymentPolicy=NONE&includeClosed=true&bestRateOnly=false&view=FULL&sort=DISTANCE',
                    headers: {
                      'Authorization': 'Bearer ' + access_token
                    },
                    dataType: 'JSON',
                    error: function () {
                      alert('Network Error: Failed getting hotel info, please try again');
                      showMsg(false);
                    },
                    success: function (res) {
                      showMsg(false);
                      $('#ac-list').html('')
                      $('#ac-info').attr('style', 'display:block;');
                      let counter = 0; // count available hotel

                      $.each(res.data, function (index, item) {
                        // for now it will only display hotels that are available
                        if (res.data.length == 0) {
                          $('#ac-list').append(
                            '<li style="padding: 10px;"><h2>Sorry, there is no available room on the selected date.</h2></li>'
                          )
                        } else {
                          if (item.available == true) {
                            counter++;
                            $('#ac-list').append('<li><hotel-card name="' + item.hotel.name +
                              '" rating="' + item.hotel.rating + '" addr="' + item.hotel.address
                              .lines.join(', ') +
                              '" postalCode="' + item.hotel.address.postalCode + '" phone="' +
                              item.hotel.contact
                              .phone + '" pic="' + item.hotel.media[0].uri +
                              '"></hotel-card></li>')
                          }
                        }
                      })

                      if (counter == 0) {
                        $('#ac-list').append(
                          '<li style="padding: 10px;"><h2>Sorry, there is no available room on the selected date.</h2></li>'
                        )
                      }
                    }
                  })
                }
              })


            }
          })
          // #######
          // Case 4: The holiday is less than 4 days away
          // #######
        } else {
          console.log('display forecast')

          // fetch for weather info
          showMsg(true);
          const api_key = '51563523b41b41b3bd981420212804'
          const days = 7; // this does not have effect due to account limitation
          $.ajax({
            type: 'GET',
            crossDomain: true,
            url: 'http://api.weatherapi.com/v1/forecast.json?key=' + api_key +
              '&q=' + selectedCity + '&days=' + days,
            dataType: 'JSON',
            error: function () {
              alert('Network Error: Failed getting weather info, please try again');
              showMsg(false);
            },
            success: function (res) {
              lat = res.location.lat;
              lon = res.location.lon;
              console.log('latitude: ' + lat + ' longtitude: ' + lon);

              showMsg(false);
              $('#weather-list').html('')
              $('#weather-info').attr('style', 'display:block;');
              // pass the params to the weather card template
              $.each(res.forecast.forecastday, function (index, item) {
                $('#weather-list').append('<li><weather-card date="' + item.date + '" condition="' +
                  item.day.condition.text + '"iconURL="' + item.day.condition.icon + '" avgtemp="' +
                  item
                  .day.avgtemp_c +
                  '" maxtemp="' + item.day.maxtemp_c + '" mintemp="' + item.day.mintemp_c +
                  '" rain="' +
                  item.day.daily_chance_of_rain + '" wind="' + item.day.maxwind_kph +
                  '"></weather-card></li>')
              })

              // #######
              // Get the information of available hotels
              // #######

              showMsg(true);
              $.ajax({
                type: 'POST',
                crossDomain: true,
                contentType: 'application/x-www-form-urlencoded',
                url: 'https://test.api.amadeus.com/v1/security/oauth2/token',

                data: {
                  'grant_type': 'client_credentials',
                  'client_id': 'zxJ9K59fVIoWH2KPvSl2PXq6yTQ8qOgN',
                  'client_secret': 'sGL8iLgjn8C7yXME'
                },
                dataType: 'JSON',
                error: function () {
                  alert('Network Error: Failed getting token for hotel info, please try again');
                  showMsg(false);
                },
                success: function (res) {
                  const access_token = res.access_token;

                  $.ajax({
                    type: 'GET',
                    crossDomain: true,
                    url: 'https://test.api.amadeus.com/v2/shopping/hotel-offers?latitude=' + lat +
                      '&longitude=' + lon + '&checkInDate=' + selectedHoliday +
                      '&roomQuantity=1&adults=2&radius=25&radiusUnit=KM&paymentPolicy=NONE&includeClosed=true&bestRateOnly=false&view=FULL&sort=DISTANCE',
                    headers: {
                      'Authorization': 'Bearer ' + access_token
                    },
                    dataType: 'JSON',
                    error: function () {
                      alert('Network Error: Failed getting hotel info, please try again');
                      showMsg(false);
                    },
                    success: function (res) {
                      showMsg(false);
                      $('#ac-list').html('')
                      $('#ac-info').attr('style', 'display:block;');

                      let counter = 0; // count available hotel

                      $.each(res.data, function (index, item) {
                        // for now it will only display hotels that are available
                        if (res.data.length == 0) {
                          $('#ac-list').append(
                            '<li style="padding: 10px;"><h2>Sorry, there is no available room on the selected date.</h2></li>'
                          )
                        } else {
                          if (item.available == true) {
                            counter++;
                            $('#ac-list').append('<li><hotel-card name="' + item.hotel.name +
                              '" rating="' + item.hotel.rating + '" addr="' + item.hotel.address
                              .lines.join(', ') +
                              '" postalCode="' + item.hotel.address.postalCode + '" phone="' +
                              item.hotel.contact
                              .phone + '" pic="' + item.hotel.media[0].uri +
                              '"></hotel-card></li>')
                          }
                        }
                      })

                      if (counter == 0) {
                        $('#ac-list').append(
                          '<li style="padding: 10px;"><h2>Sorry, there is no available room on the selected date.</h2></li>'
                        )
                      }

                    }
                  })
                }
              })
            }
          })
        }


      } else {
        alert('invalid selection of holiday')
      }

    }

    function getCurrentDate() {
      let now = new Date();
      //let year = now.getFullYear(); 
      let year = 2021;
      let month = now.getMonth() + 1;
      let date = now.getDate();

      const result = year + '-' + month + '-' + date

      return result;

    }


    function dateDiff(sDate1, sDate2) { // format: yyyy-mm-dd
      var aDate, oDate1, oDate2, iDays
      aDate = sDate1.split("-")
      oDate1 = new Date(aDate[1] + '-' + aDate[2] + '-' + aDate[0]) //convert to format: xx-xx-xxxx
      aDate = sDate2.split("-")
      oDate2 = new Date(aDate[1] + '-' + aDate[2] + '-' + aDate[0])
      //iDays = parseInt(Math.abs(oDate1 - oDate2) / 1000 / 60 / 60 / 24)
      iDays = parseInt((oDate1 - oDate2) / 1000 / 60 / 60 / 24)
      return iDays
    }

    // code for testing
    $('#btn').click(function () {
      console.log('clicked');
      // request for a token for hotel info
      $.ajax({
        type: 'POST',
        crossDomain: true,
        contentType: 'application/x-www-form-urlencoded',
        url: 'https://test.api.amadeus.com/v1/security/oauth2/token',

        data: {
          'grant_type': 'client_credentials',
          'client_id': 'zxJ9K59fVIoWH2KPvSl2PXq6yTQ8qOgN',
          'client_secret': 'sGL8iLgjn8C7yXME'
        },
        dataType: 'JSON',
        error: function () {
          alert('Network error: Failed getting token for hotel info, please try again');
          showMsg(false);
        },
        success: function (res) {
          const access_token = res.access_token;

          $.ajax({
            type: 'GET',
            crossDomain: true,
            url: 'https://test.api.amadeus.com/v2/shopping/hotel-offers?latitude=33.64&longitude=116.98&checkInDate=2021-06-01&roomQuantity=1&adults=2&radius=20&radiusUnit=KM&paymentPolicy=NONE&includeClosed=false&bestRateOnly=false&view=FULL&sort=NONE',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            dataType: 'JSON',
            error: function () {
              alert('Network error, please try again');
              showMsg(false);
            },
            success: function (res) {

            }
          })
        }
      })
    })
  </script>
</body>

</html>